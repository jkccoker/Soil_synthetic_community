# Activate QIIME2 anaconda environment
conda activate qiime2-2020.11

### Import FASTQ files into QIIME2 (Casava1.8 format). Files are in folder <commDynamics_FASTQ/>
qiime tools import --type 'SampleData[PairedEndSequencesWithQuality]' --input-path commDynamics_FASTQ/ --input-format CasavaOneEightSingleLanePerSampleDirFmt --output-path demux-paired.qza

### Join paired-end reads
qiime vsearch join-pairs --i-demultiplexed-seqs demux-paired.qza --o-joined-sequences demux-joined.qza

### Generate visualization file to assess quantity, length, and quality of joined sequences
qiime demux summarize --i-data demux-joined.qza --o-visualization demux-joined.qzv

### Quality-filter and denoise reads using Deblur, default parameters
qiime quality-filter q-score --i-demux demux-joined.qza --o-filtered-sequences demux-joined-filter.qza --o-filter-stats demux-joined-filterstats.qza

qiime deblur denoise-16S --i-demultiplexed-seqs demux-joined-filter.qza --p-trim-length 420 --o-representative-sequences rep-seqs-joined.qza --o-table table-joined.qza --p-sample-stats --o-stats deblur-stats-joined.qza
# --p-trim-length determined by length and quality of reads in demux-joined.qzv

### Generate phylogenetic tree and alpha rarefaction curve
qiime phylogeny align-to-tree-mafft-fasttree --i-sequences rep-seqs-joined.qza --o-alignment aligned-rep-seqs-joined.qza --o-masked-alignment masked-aligned-rep-seqs-joined.qza --o-tree unrooted-tree-joined.qza --o-rooted-tree rooted-tree-joined.qza

qiime diversity alpha-rarefaction --i-table table-joined.qza --i-phylogeny rooted-tree-joined.qza --p-max-depth 2000 --m-metadata-file metadata_commDynamics.tsv --o-visualization alpha-rarefaction-joined.qzv

### Basic alpha- and beta-diversity analyses
qiime diversity core-metrics-phylogenetic --i-phylogeny rooted-tree-joined.qza --i-table table-joined.qza --p-sampling-depth 500 --m-metadata-file metadata_commDynamics.tsv --output-dir core-metrics-phylogenetics

### Train classifier with custom database and primers used for library preparation
qiime feature-classifier extract-reads --i-sequences isolates_16Sseq_classifier.qza --p-f-primer CCTACGGGNGGCWGCAG --p-r-primer GACTACHVGGGTATCTAATCC --p-trunc-len 420 --o-reads isolates_ref_seqs.qza

qiime feature-classifier fit-classifier-naive-bayes --i-reference-reads isolates_ref_seqs.qza --i-reference-taxonomy isolates_taxonomy.qza --verbose --o-classifier isolates_classifier_commDynamics.qza

### Align reads to custom classifier and generate taxonomy barplots
qiime feature-classifier classify-sklearn --i-classifier isolates_classifier_commDynamics.qza --i-reads rep-seqs-joined.qza --o-classification taxonomy-joined.qza

qiime taxa barplot --i-table table-joined.qza --i-taxonomy taxonomy-joined.qza --m-metadata-file metadata_commDynamics.tsv --o-visualization taxa-plots-joined.qzv